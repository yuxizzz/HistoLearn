---
title: "Introduction to HistoLearn"
author: "Yuxi Zhu"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
vignette: >
  %\VignetteIndexEntry{Introduction to HistoLearn}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(fig.align = "center", 
               out.width = "90%",
               fig.width = 6, fig.height = 5.5,
               dev.args=list(pointsize=10),
               par = TRUE, # needed for setting hook 
               collapse = TRUE, # collapse input & ouput code in chunks
               warning = FALSE)

knit_hooks$set(par = function(before, options, envir)
  { if(before && options$fig.show != "none") 
       par(family = "sans", mar=c(4.1,4.1,1.1,1.1), mgp=c(3,1,0), tcl=-0.5)
})
set.seed(1) # for exact reproducibility
```

## Introduction

**HistoLearn** is a simple R package for interpreting and visualizing foundation model derived histological features and training supervised machine learning models using these features. The function ***load_embeddings*** takes in the feature matrix or dataframe with each row representing a sample and, optionally, a label dataframe or matrix that specify the labels for each sample and create a **histofeature** object for downstream analysis. Function ***visualize_embeddings*** allows the user to visualize the embeddings of type **histofeature** using PCA. Function ***train_model*** allows the user to first use dimensional reduction method to reduce the dimension and train a supervised machine learning model to conduct classifications. **evaludate_model** is available for evaluating and inferring the model on testing data of same structure. The shiny implementation of *HistoLearn* is available as ***HistoLearn*** (under construction). For more information, see details below. **This document gives a tour of HistoLearn (version 0.1.0) functionalities**. It was written in R Markdown, using the [knitr](https://cran.r-project.org/package=knitr) package for production.

See `help(package = "HistoLearn")` for further details and references provided by `citation("HistoLearn")`. To download **HistoLearn**, use the following commands:

``` r
require("devtools")
install_github("yuxizzz/HistoLearn", build_vignettes = TRUE)
library("HistoLearn")
```

To list all functions available in the package:

``` r
lsf.str("package:HistoLearn")
```

<br>

## Example Usage

The embeddings represent nine colorectal tissue classes—Adipose (ADI), background (BACK), debris (DEB), lymphocytes (LYM), mucus (MUC), smooth muscle (MUS), normal colon mucosa (NORM), cancer-associated stroma (STR), colorectal adenocarcinoma epithelium (TUM). These embeddings were derived from 86 FFPE colorectal slides released by Kather, Halama, and Marx (2018) and processed using the foundation model introduced by Chen et al. (2024). The workflow is inspired by Chen et al. (2024).

### 1. Load the data

```{r}
library(HistoLearn)
```

Here, we are using the example dataset from the package. Note that the column dimension of the train set embeddings and test set embeddings must be the same.

```{r}
trainset <- HistoLearn::load_embeddings(feature=HistoLearn::train_embeddings, label=HistoLearn::train_labels)
testset <- HistoLearn::load_embeddings(feature=HistoLearn::test_embeddings, label=HistoLearn::test_labels)
```

### 2. Visualize Data

We will first visualize the pca embeddings of the histological feature. Ideally, we want to see that dots of the same label to be clustered together.

Visualize the data using the first 2 dimensions of pca. 

```{r, fig.width = 8}
visualize_embeddings(input_data=trainset, dimensions = 2, type='pca')
```

Visualize first 4 dimensions of pca using a paired plot. Here we examine whether higher-order components also reveal class separation patterns.

```{r, fig.width = 8}
visualize_embeddings(input_data=trainset, dimensions = 4, type='pca')
```

### 3. Train and Evaluate the Classification Models

Now, we are training the downstream classification model using the default PCA and KNN.
By default, train_model will perform PCA for dimensionality reduction, retains the specified number of components (`dr_k`) and fits a kNN classifier on the reduced embeddings.

Here we train a model using 20 PCA components. 

```{r}
model <- train_model(trainset, dr = "pca", dr_k = 20, model = "knn")
```

we will evaluate the model on the our test set. `evaluate_model()` applies the fitted PCA model to the test embeddings, apply classifiers to generate predictions, computes train and test accuracy, and returns confusion-matrix plots for both train set and test set. To prevent overfit, in practice, we want to see that the train and test set to be roughly the same. 

```{r}
evaluate_model(trained_model=model, test_data = testset)
```

Another classification model to try is logistic regression. This is called linear probing as introduced by Chen et al. (2024). 
```{r}
model <- train_model(trainset, dr = "pca", dr_k = 20, model = "logistic")
```
```{r}
model$method
```

we will evaluate the model on the our test set as well.

```{r}
evaluate_model(trained_model=model, test_data = testset)
```

## References

```         
Chen, R. J., Ding, T., Lu, M. Y., Williamson, D. F. K., Jaume, G., 
Song, A. H., Chen, B., Zhang, A., Shao, D., Shaban, M., Williams, M.,
Oldenburg, L., Weishaupt, L. L., Wang, J. J., Vaidya, A., Le, L. P., Gerber, 
G., Sahai, S., Williams, W., & Mahmood, F. (2024). Towards a general-purpose
foundation model for computational pathology. Nature Medicine, 30(3), 850–862.
https://doi.org/10.1038/s41591-024-02857-3

Kather, J. N., Halama, N., & Marx, A. (2018). 100,000 histological images of
human colorectal cancer and healthy tissue (v0.1) \[Data set\]. Zenodo. https://doi.org/10.5281/zenodo.1214456
```

------------------------------------------------------------------------

```{r}
sessionInfo()
```

::: ::::
:::
